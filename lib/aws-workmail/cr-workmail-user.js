"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const client_workmail_1 = require("@aws-sdk/client-workmail");
const getSecretValue = async (secretId) => {
    const client = new client_secrets_manager_1.SecretsManagerClient({});
    const cmd = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: secretId });
    let secretString;
    try {
        const output = await client.send(cmd);
        secretString = output.SecretString;
    }
    catch (err) {
        console.error(err);
        throw err;
    }
    finally {
        client.destroy();
    }
    const value = JSON.parse(secretString);
    return value;
};
/** Describe the email domain of the WorkMail organization */
const describeMailDomain = async (region, organizationId) => {
    const client = new client_workmail_1.WorkMailClient({ region });
    const cmd = new client_workmail_1.DescribeOrganizationCommand({ OrganizationId: organizationId });
    let mailDomain;
    try {
        const output = await client.send(cmd);
        mailDomain = output.DefaultMailDomain;
    }
    catch (err) {
        console.error(err);
        throw err;
    }
    finally {
        client.destroy();
    }
    return mailDomain;
};
/** Register the email address to the WorkMail organization */
const registerToWorkMail = async (region, organizationId, entityId, email) => {
    const client = new client_workmail_1.WorkMailClient({ region });
    const cmd = new client_workmail_1.RegisterToWorkMailCommand({
        OrganizationId: organizationId,
        EntityId: entityId,
        Email: email,
    });
    try {
        await client.send(cmd);
    }
    catch (err) {
        console.error(err);
        throw err;
    }
    finally {
        client.destroy();
    }
};
/** Deregister the email address to the WorkMail organization */
const deregisterFromWorkMail = async (region, organizationId, entityId) => {
    const client = new client_workmail_1.WorkMailClient({ region });
    const cmd = new client_workmail_1.DeregisterFromWorkMailCommand({
        OrganizationId: organizationId,
        EntityId: entityId,
    });
    try {
        await client.send(cmd);
    }
    catch (err) {
        console.error(err);
        throw err;
    }
    finally {
        client.destroy();
    }
};
/** Create the user from the WorkMail organization */
const createUser = async (region, organizationId, username, password) => {
    const mailDomain = await describeMailDomain(region, organizationId);
    const email = `${username.toLowerCase()}@${mailDomain}`;
    const client = new client_workmail_1.WorkMailClient({ region });
    const cmd = new client_workmail_1.CreateUserCommand({
        OrganizationId: organizationId,
        Name: username,
        Password: password,
        DisplayName: username,
    });
    let userId;
    try {
        const output = await client.send(cmd);
        userId = output.UserId;
    }
    catch (err) {
        console.error(err);
        throw err;
    }
    finally {
        client.destroy();
    }
    await registerToWorkMail(region, organizationId, userId, email);
    return { userId, email };
};
/** Delete the user from the WorkMail organization */
const deleteUser = async (region, organizationId, userId) => {
    const client = new client_workmail_1.WorkMailClient({ region });
    await deregisterFromWorkMail(region, organizationId, userId);
    const cmd = new client_workmail_1.DeleteUserCommand({
        OrganizationId: organizationId,
        UserId: userId,
    });
    try {
        await client.send(cmd);
    }
    catch (err) {
        console.error(err);
        throw err;
    }
    finally {
        client.destroy();
    }
};
const handler = async (event, _context) => {
    const region = event.ResourceProperties.Region;
    const organizationId = event.ResourceProperties.OrganizationId;
    const username = event.ResourceProperties.Username;
    const password = event.ResourceProperties.Password;
    switch (event.RequestType) {
        case 'Create': {
            const user = await createUser(region, organizationId, username, password);
            return { PhysicalResourceId: user.userId, Data: { UserId: user.userId, Email: user.email } };
        }
        case 'Update': {
            const oldUserId = event.PhysicalResourceId;
            await deleteUser(region, organizationId, oldUserId);
            const user = await createUser(region, organizationId, username, password);
            return { PhysicalResourceId: user.userId, Data: { UserId: user.userId, Email: user.email } };
        }
        case 'Delete': {
            const userId = event.PhysicalResourceId;
            await deleteUser(region, organizationId, userId);
            return {};
        }
    }
    ;
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Itd29ya21haWwtdXNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hd3Mtd29ya21haWwvY3Itd29ya21haWwtdXNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0RUFBOEY7QUFDOUYsOERBQXVMO0FBUXZMLE1BQU0sY0FBYyxHQUFHLEtBQUssRUFBRSxRQUFnQixFQUFFLEVBQUU7SUFDaEQsTUFBTSxNQUFNLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxNQUFNLEdBQUcsR0FBRyxJQUFJLDhDQUFxQixDQUFDLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDOUQsSUFBSSxZQUFvQixDQUFDO0lBQ3pCLElBQUk7UUFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxZQUFhLENBQUM7S0FDckM7SUFBQyxPQUFPLEdBQUcsRUFBRTtRQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkIsTUFBTSxHQUFHLENBQUM7S0FDWDtZQUFTO1FBQ1IsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO0tBQ2xCO0lBQ0QsTUFBTSxLQUFLLEdBQXVCLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDM0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDLENBQUM7QUFFRiw2REFBNkQ7QUFDN0QsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLEVBQUUsTUFBYyxFQUFFLGNBQXNCLEVBQUUsRUFBRTtJQUMxRSxNQUFNLE1BQU0sR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQzlDLE1BQU0sR0FBRyxHQUFHLElBQUksNkNBQTJCLENBQUMsRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztJ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QmxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VjcmV0c01hbmFnZXJDbGllbnQsIEdldFNlY3JldFZhbHVlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZWNyZXRzLW1hbmFnZXInO1xyXG5pbXBvcnQgeyBXb3JrTWFpbENsaWVudCwgQ3JlYXRlVXNlckNvbW1hbmQsIERlbGV0ZVVzZXJDb21tYW5kLCBSZWdpc3RlclRvV29ya01haWxDb21tYW5kLCBEZXJlZ2lzdGVyRnJvbVdvcmtNYWlsQ29tbWFuZCwgRGVzY3JpYmVPcmdhbml6YXRpb25Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXdvcmttYWlsJztcclxuaW1wb3J0IHsgQ2RrQ3VzdG9tUmVzb3VyY2VIYW5kbGVyIH0gZnJvbSAnYXdzLWxhbWJkYSc7XHJcblxyXG5pbnRlcmZhY2UgV29ya01haWxVc2VyU2VjcmV0IHtcclxuICB1c2VybmFtZTogc3RyaW5nO1xyXG4gIHBhc3N3b3JkOiBzdHJpbmc7XHJcbn1cclxuXHJcbmNvbnN0IGdldFNlY3JldFZhbHVlID0gYXN5bmMgKHNlY3JldElkOiBzdHJpbmcpID0+IHtcclxuICBjb25zdCBjbGllbnQgPSBuZXcgU2VjcmV0c01hbmFnZXJDbGllbnQoe30pO1xyXG4gIGNvbnN0IGNtZCA9IG5ldyBHZXRTZWNyZXRWYWx1ZUNvbW1hbmQoeyBTZWNyZXRJZDogc2VjcmV0SWQgfSk7XHJcbiAgbGV0IHNlY3JldFN0cmluZzogc3RyaW5nO1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCBjbGllbnQuc2VuZChjbWQpO1xyXG4gICAgc2VjcmV0U3RyaW5nID0gb3V0cHV0LlNlY3JldFN0cmluZyE7XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbiAgICB0aHJvdyBlcnI7XHJcbiAgfSBmaW5hbGx5IHtcclxuICAgIGNsaWVudC5kZXN0cm95KCk7XHJcbiAgfVxyXG4gIGNvbnN0IHZhbHVlOiBXb3JrTWFpbFVzZXJTZWNyZXQgPSBKU09OLnBhcnNlKHNlY3JldFN0cmluZyk7XHJcbiAgcmV0dXJuIHZhbHVlO1xyXG59O1xyXG5cclxuLyoqIERlc2NyaWJlIHRoZSBlbWFpbCBkb21haW4gb2YgdGhlIFdvcmtNYWlsIG9yZ2FuaXphdGlvbiAqL1xyXG5jb25zdCBkZXNjcmliZU1haWxEb21haW4gPSBhc3luYyAocmVnaW9uOiBzdHJpbmcsIG9yZ2FuaXphdGlvbklkOiBzdHJpbmcpID0+IHtcclxuICBjb25zdCBjbGllbnQgPSBuZXcgV29ya01haWxDbGllbnQoeyByZWdpb24gfSk7XHJcbiAgY29uc3QgY21kID0gbmV3IERlc2NyaWJlT3JnYW5pemF0aW9uQ29tbWFuZCh7IE9yZ2FuaXphdGlvbklkOiBvcmdhbml6YXRpb25JZCB9KTtcclxuICBsZXQgbWFpbERvbWFpbjogc3RyaW5nO1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCBjbGllbnQuc2VuZChjbWQpO1xyXG4gICAgbWFpbERvbWFpbiA9IG91dHB1dC5EZWZhdWx0TWFpbERvbWFpbiE7XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbiAgICB0aHJvdyBlcnI7XHJcbiAgfSBmaW5hbGx5IHtcclxuICAgIGNsaWVudC5kZXN0cm95KCk7XHJcbiAgfVxyXG4gIHJldHVybiBtYWlsRG9tYWluO1xyXG59O1xyXG5cclxuLyoqIFJlZ2lzdGVyIHRoZSBlbWFpbCBhZGRyZXNzIHRvIHRoZSBXb3JrTWFpbCBvcmdhbml6YXRpb24gKi9cclxuY29uc3QgcmVnaXN0ZXJUb1dvcmtNYWlsID0gYXN5bmMgKHJlZ2lvbjogc3RyaW5nLCBvcmdhbml6YXRpb25JZDogc3RyaW5nLCBlbnRpdHlJZDogc3RyaW5nLCBlbWFpbDogc3RyaW5nKSA9PiB7XHJcbiAgY29uc3QgY2xpZW50ID0gbmV3IFdvcmtNYWlsQ2xpZW50KHsgcmVnaW9uIH0pO1xyXG4gIGNvbnN0IGNtZCA9IG5ldyBSZWdpc3RlclRvV29ya01haWxDb21tYW5kKHtcclxuICAgIE9yZ2FuaXphdGlvbklkOiBvcmdhbml6YXRpb25JZCxcclxuICAgIEVudGl0eUlkOiBlbnRpdHlJZCxcclxuICAgIEVtYWlsOiBlbWFpbCxcclxuICB9KTtcclxuICB0cnkge1xyXG4gICAgYXdhaXQgY2xpZW50LnNlbmQoY21kKTtcclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcclxuICAgIHRocm93IGVycjtcclxuICB9IGZpbmFsbHkge1xyXG4gICAgY2xpZW50LmRlc3Ryb3koKTtcclxuICB9XHJcbn07XHJcblxyXG4vKiogRGVyZWdpc3RlciB0aGUgZW1haWwgYWRkcmVzcyB0byB0aGUgV29ya01haWwgb3JnYW5pemF0aW9uICovXHJcbmNvbnN0IGRlcmVnaXN0ZXJGcm9tV29ya01haWwgPSBhc3luYyAocmVnaW9uOiBzdHJpbmcsIG9yZ2FuaXphdGlvbklkOiBzdHJpbmcsIGVudGl0eUlkOiBzdHJpbmcpID0+IHtcclxuICBjb25zdCBjbGllbnQgPSBuZXcgV29ya01haWxDbGllbnQoeyByZWdpb24gfSk7XHJcbiAgY29uc3QgY21kID0gbmV3IERlcmVnaXN0ZXJGcm9tV29ya01haWxDb21tYW5kKHtcclxuICAgIE9yZ2FuaXphdGlvbklkOiBvcmdhbml6YXRpb25JZCxcclxuICAgIEVudGl0eUlkOiBlbnRpdHlJZCxcclxuICB9KTtcclxuICB0cnkge1xyXG4gICAgYXdhaXQgY2xpZW50LnNlbmQoY21kKTtcclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcclxuICAgIHRocm93IGVycjtcclxuICB9IGZpbmFsbHkge1xyXG4gICAgY2xpZW50LmRlc3Ryb3koKTtcclxuICB9XHJcbn07XHJcblxyXG4vKiogQ3JlYXRlIHRoZSB1c2VyIGZyb20gdGhlIFdvcmtNYWlsIG9yZ2FuaXphdGlvbiAqL1xyXG5jb25zdCBjcmVhdGVVc2VyID0gYXN5bmMgKHJlZ2lvbjogc3RyaW5nLCBvcmdhbml6YXRpb25JZDogc3RyaW5nLCB1c2VybmFtZTogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKSA9PiB7XHJcbiAgY29uc3QgbWFpbERvbWFpbiA9IGF3YWl0IGRlc2NyaWJlTWFpbERvbWFpbihyZWdpb24sIG9yZ2FuaXphdGlvbklkKTtcclxuICBjb25zdCBlbWFpbCA9IGAke3VzZXJuYW1lLnRvTG93ZXJDYXNlKCl9QCR7bWFpbERvbWFpbn1gO1xyXG4gIGNvbnN0IGNsaWVudCA9IG5ldyBXb3JrTWFpbENsaWVudCh7IHJlZ2lvbiB9KTtcclxuICBjb25zdCBjbWQgPSBuZXcgQ3JlYXRlVXNlckNvbW1hbmQoe1xyXG4gICAgT3JnYW5pemF0aW9uSWQ6IG9yZ2FuaXphdGlvbklkLFxyXG4gICAgTmFtZTogdXNlcm5hbWUsXHJcbiAgICBQYXNzd29yZDogcGFzc3dvcmQsXHJcbiAgICBEaXNwbGF5TmFtZTogdXNlcm5hbWUsXHJcbiAgfSk7XHJcbiAgbGV0IHVzZXJJZDogc3RyaW5nO1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCBjbGllbnQuc2VuZChjbWQpO1xyXG4gICAgdXNlcklkID0gb3V0cHV0LlVzZXJJZCE7XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGVycik7XHJcbiAgICB0aHJvdyBlcnI7XHJcbiAgfSBmaW5hbGx5IHtcclxuICAgIGNsaWVudC5kZXN0cm95KCk7XHJcbiAgfVxyXG4gIGF3YWl0IHJlZ2lzdGVyVG9Xb3JrTWFpbChyZWdpb24sIG9yZ2FuaXphdGlvbklkLCB1c2VySWQsIGVtYWlsKTtcclxuICByZXR1cm4geyB1c2VySWQsIGVtYWlsIH07XHJcbn07XHJcblxyXG4vKiogRGVsZXRlIHRoZSB1c2VyIGZyb20gdGhlIFdvcmtNYWlsIG9yZ2FuaXphdGlvbiAqL1xyXG5jb25zdCBkZWxldGVVc2VyID0gYXN5bmMgKHJlZ2lvbjogc3RyaW5nLCBvcmdhbml6YXRpb25JZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZykgPT4ge1xyXG4gIGNvbnN0IGNsaWVudCA9IG5ldyBXb3JrTWFpbENsaWVudCh7IHJlZ2lvbiB9KTtcclxuICBhd2FpdCBkZXJlZ2lzdGVyRnJvbVdvcmtNYWlsKHJlZ2lvbiwgb3JnYW5pemF0aW9uSWQsIHVzZXJJZCk7XHJcbiAgY29uc3QgY21kID0gbmV3IERlbGV0ZVVzZXJDb21tYW5kKHtcclxuICAgIE9yZ2FuaXphdGlvbklkOiBvcmdhbml6YXRpb25JZCxcclxuICAgIFVzZXJJZDogdXNlcklkLFxyXG4gIH0pO1xyXG4gIHRyeSB7XHJcbiAgICBhd2FpdCBjbGllbnQuc2VuZChjbWQpO1xyXG4gIH0gY2F0Y2ggKGVycikge1xyXG4gICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgdGhyb3cgZXJyO1xyXG4gIH0gZmluYWxseSB7XHJcbiAgICBjbGllbnQuZGVzdHJveSgpO1xyXG4gIH1cclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBDZGtDdXN0b21SZXNvdXJjZUhhbmRsZXIgPSBhc3luYyAoZXZlbnQsIF9jb250ZXh0KSA9PiB7XHJcbiAgY29uc3QgcmVnaW9uOiBzdHJpbmcgPSBldmVudC5SZXNvdXJjZVByb3BlcnRpZXMuUmVnaW9uO1xyXG4gIGNvbnN0IG9yZ2FuaXphdGlvbklkOiBzdHJpbmcgPSBldmVudC5SZXNvdXJjZVByb3BlcnRpZXMuT3JnYW5pemF0aW9uSWQ7XHJcbiAgY29uc3QgdXNlcm5hbWU6IHN0cmluZyA9IGV2ZW50LlJlc291cmNlUHJvcGVydGllcy5Vc2VybmFtZTtcclxuICBjb25zdCBwYXNzd29yZDogc3RyaW5nID0gZXZlbnQuUmVzb3VyY2VQcm9wZXJ0aWVzLlBhc3N3b3JkO1xyXG5cclxuICBzd2l0Y2ggKGV2ZW50LlJlcXVlc3RUeXBlKSB7XHJcbiAgICBjYXNlICdDcmVhdGUnOiB7XHJcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBjcmVhdGVVc2VyKHJlZ2lvbiwgb3JnYW5pemF0aW9uSWQsIHVzZXJuYW1lLCBwYXNzd29yZCk7XHJcbiAgICAgIHJldHVybiB7IFBoeXNpY2FsUmVzb3VyY2VJZDogdXNlci51c2VySWQsIERhdGE6IHsgVXNlcklkOiB1c2VyLnVzZXJJZCwgRW1haWw6IHVzZXIuZW1haWwgfSB9O1xyXG4gICAgfVxyXG4gICAgY2FzZSAnVXBkYXRlJzoge1xyXG4gICAgICBjb25zdCBvbGRVc2VySWQgPSBldmVudC5QaHlzaWNhbFJlc291cmNlSWQ7XHJcbiAgICAgIGF3YWl0IGRlbGV0ZVVzZXIocmVnaW9uLCBvcmdhbml6YXRpb25JZCwgb2xkVXNlcklkKTtcclxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGNyZWF0ZVVzZXIocmVnaW9uLCBvcmdhbml6YXRpb25JZCwgdXNlcm5hbWUsIHBhc3N3b3JkKTtcclxuICAgICAgcmV0dXJuIHsgUGh5c2ljYWxSZXNvdXJjZUlkOiB1c2VyLnVzZXJJZCwgRGF0YTogeyBVc2VySWQ6IHVzZXIudXNlcklkLCBFbWFpbDogdXNlci5lbWFpbCB9IH07XHJcbiAgICB9XHJcbiAgICBjYXNlICdEZWxldGUnOiB7XHJcbiAgICAgIGNvbnN0IHVzZXJJZCA9IGV2ZW50LlBoeXNpY2FsUmVzb3VyY2VJZDtcclxuICAgICAgYXdhaXQgZGVsZXRlVXNlcihyZWdpb24sIG9yZ2FuaXphdGlvbklkLCB1c2VySWQpO1xyXG4gICAgICByZXR1cm4ge307XHJcbiAgICB9XHJcbiAgfTtcclxufTsiXX0=